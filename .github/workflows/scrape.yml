name: MyAuto Car Listing Monitor

on:
  schedule:
    # Run every 10 minutes
    - cron: '*/10 * * * *'
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'

jobs:
  monitor:
    name: Run Car Listing Monitor
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 python-dotenv "psycopg2-binary>=2.9.0" urllib3 certifi "playwright>=1.40.0" lxml

      - name: Install Playwright browsers
        run: |
          playwright install chromium

      - name: Run car listing monitor
        env:
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_NAME: ${{ secrets.DB_NAME }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          CONFIG_PATH: 'config.json'
          LOG_LEVEL: 'INFO'
        run: |
          echo "[*] Starting monitoring cycle at $(date)"
          python main.py
          RESULT=$?
          echo "[*] Monitoring cycle completed with exit code: $RESULT"
          exit $RESULT

      - name: Send error notification on failure
        if: failure()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ ! -z "$TELEGRAM_BOT_TOKEN" ] && [ ! -z "$TELEGRAM_CHAT_ID" ]; then
            curl -s -X POST \
              "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -H "Content-Type: application/json" \
              -d '{
                "chat_id": "'$TELEGRAM_CHAT_ID'",
                "text": "<b>[ERROR] MyAuto Monitor Failed</b>\n\nWorkflow failed at: '"$(date)"'\n\nCheck GitHub Actions for details.",
                "parse_mode": "HTML"
              }'
            echo "[OK] Error notification sent to Telegram"
          fi
        shell: bash
        continue-on-error: true

      - name: Log workflow completion
        if: always()
        run: |
          echo "[*] Workflow completed at $(date)"

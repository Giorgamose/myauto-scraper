name: MyAuto Car Listing Monitor

# Trigger schedule and manual dispatch
on:
  schedule:
    # Run every 10 minutes
    - cron: '*/10 * * * *'

  # Allow manual trigger for testing
  workflow_dispatch:

# Environment variables available to all jobs
env:
  PYTHON_VERSION: '3.11'
  REQUIREMENTS_FILE: 'requirements.txt'

jobs:
  monitor:
    name: Run Car Listing Monitor
    runs-on: ubuntu-latest

    # Allow 10-minute timeout per job
    timeout-minutes: 10

    steps:
      # 1. Checkout repository code
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # 2. Setup Python environment
      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      # 3. Cache pip dependencies for faster runs
      - name: Cache pip packages
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # 4. Install Python dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r ${{ env.REQUIREMENTS_FILE }}

      # 5. Download previous database state from artifacts
      - name: Download previous database state
        uses: actions/download-artifact@v3
        with:
          name: database-state
          path: ./artifacts/
        continue-on-error: true

      # 6. Restore database if artifact exists
      - name: Restore database artifact
        run: |
          if [ -f ./artifacts/database-state.db ]; then
            echo "[OK] Found previous database state, restoring..."
            cp ./artifacts/database-state.db ./database-state.db
          else
            echo "[*] No previous database state found, will create new"
          fi
        shell: bash
        continue-on-error: true

      # 7. Run the monitoring script
      - name: Run car listing monitor
        env:
          TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          CONFIG_PATH: 'config.json'
          LOG_LEVEL: 'INFO'
        run: |
          echo "[*] Starting monitoring cycle at $(date)"
          python main.py
          RESULT=$?
          echo "[*] Monitoring cycle completed with exit code: $RESULT"
          exit $RESULT

      # 8. Prepare database for artifact upload
      - name: Prepare database artifact
        if: always()
        run: |
          mkdir -p ./artifacts/
          # Database state is stored by turso, but we could save a backup here
          echo "[OK] Database artifact prepared"
        shell: bash

      # 9. Upload database state as artifact for next run
      - name: Upload database state
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: database-state
          path: ./artifacts/
          retention-days: 7

      # 10. Notify on failure (optional)
      - name: Send error notification
        if: failure()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ ! -z "$TELEGRAM_BOT_TOKEN" ] && [ ! -z "$TELEGRAM_CHAT_ID" ]; then
            curl -s -X POST \
              "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -H "Content-Type: application/json" \
              -d '{
                "chat_id": "'$TELEGRAM_CHAT_ID'",
                "text": "<b>[ERROR] MyAuto Monitor Failed</b>\n\nWorkflow failed at: '"$(date)"'\n\nCheck GitHub Actions for details.",
                "parse_mode": "HTML"
              }'
            echo "[OK] Error notification sent to Telegram"
          fi
        shell: bash
        continue-on-error: true

      # 11. Log completion
      - name: Log workflow completion
        if: always()
        run: |
          echo "[*] Workflow completed at $(date)"
          echo "[*] GitHub Actions context available for debugging"
        shell: bash

